<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Now Playing</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- THEME SETUP --- */
        :root {
            --primary: #e50914;
            --glass: rgba(20, 20, 20, 0.9);
            --neon-blue: #00ffff;
            --neon-green: #00ff00;
            --neon-purple: #bd00ff;
            --neon-orange: #ff4500;
        }

        body {
            background: #000;
            color: #fff;
            font-family: 'Inter', sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* --- BACK BUTTON --- */
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(50, 50, 50, 0.5);
            color: white;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 30px;
            backdrop-filter: blur(5px);
            transition: 0.3s;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
        }

        .back-btn:hover {
            background: white;
            color: black;
            transform: translateX(5px);
        }

        /* --- VIDEO CONTAINER --- */
        .video-wrapper {
            position: relative;
            width: 100%;
            max-width: 1200px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        video {
            width: 100%;
            display: block;
            outline: none;
            max-height: 80vh;
        }

        /* --- CONTROLS BAR --- */
        .control-panel {
            margin-top: 20px;
            background: var(--glass);
            backdrop-filter: blur(12px);
            padding: 15px 30px;
            border-radius: 16px;
            display: flex;
            gap: 15px;
            width: auto;
            border: none;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-action {
            background: rgba(255, 255, 255, 0.1);
            color: #ddd;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn-sub:hover {
            background: rgba(0, 255, 255, 0.2);
            color: var(--neon-blue);
        }

        .btn-dl:hover {
            background: rgba(0, 255, 0, 0.2);
            color: var(--neon-green);
        }

        .btn-ext {
            border: 1px solid var(--neon-purple);
            color: var(--neon-purple);
        }

        .btn-ext:hover {
            background: var(--neon-purple);
            color: white;
        }

        .btn-turbo {
            border: 1px solid var(--neon-orange);
            color: var(--neon-orange);
        }

        .btn-turbo:hover {
            background: var(--neon-orange);
            color: white;
            box-shadow: 0 0 15px var(--neon-orange);
        }

        #fileInput {
            display: none;
        }

        /* --- NOTIFICATION --- */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            pointer-events: none;
            z-index: 1000;
        }

        #toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(10px);
        }

        /* --- MOBILE TWEAKS --- */
        @media (max-width: 768px) {
            .video-wrapper {
                width: 100%;
                border-radius: 0;
            }

            .control-panel {
                width: 100%;
                gap: 8px;
                padding: 10px;
                margin-top: 0;
                background: #111;
                border-radius: 0;
            }

            .btn-action {
                flex: 1;
                justify-content: center;
                background: #222;
                font-size: 0.75rem;
                padding: 10px 5px;
                white-space: nowrap;
            }

            .back-btn {
                top: 15px;
                left: 15px;
                padding: 8px 12px;
                font-size: 0.75rem;
                background: rgba(0, 0, 0, 0.6);
            }
        }

        /* --- METADATA PANEL --- */
        .meta-info {
            width: 90%;
            max-width: 800px;
            text-align: center;
            margin: 20px auto 40px;
            padding: 20px;
            background: linear-gradient(180deg, rgba(20, 20, 20, 0) 0%, rgba(20, 20, 20, 0.8) 100%);
            border-radius: 12px;
        }

        .meta-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }

        .meta-desc {
            font-size: 1rem;
            color: #ccc;
            line-height: 1.6;
            max-width: 700px;
            margin: 0 auto;
        }
    </style>
</head>

<body>

    <a href="movies.html" class="back-btn"><span>‚Üê</span> Back to Movies</a>

    <div id="toast">‚úÖ Subtitle Uploaded!</div>

    <div class="video-wrapper">
        <video id="player" controls autoplay crossorigin="anonymous">
            <track id="subTrack" label="English" kind="subtitles" srclang="en" default>
        </video>
    </div>

    <div class="control-panel">
        <button class="btn-action btn-sub" onclick="document.getElementById('fileInput').click()">
            <span>üìù</span> Subs
        </button>
        <input type="file" id="fileInput" accept=".vtt,.srt">

        <a id="downloadLink" href="#" class="btn-action btn-dl" download>
            <span>‚ö°</span> Download
        </a>

        <button class="btn-action btn-ext" onclick="openExternalPlayer()">
            <span>üìΩÔ∏è</span> Play External
        </button>

        <button class="btn-action" onclick="autoSyncSubs()">
            <span>‚ú®</span> Auto-Subs
        </button>
    </div>

    <!-- Metadata Display -->
    <div id="metaContainer" class="meta-info" style="display: none;">
        <div id="metaTitle" class="meta-title"></div>
        <div id="metaDesc" class="meta-desc"></div>
    </div>

    <script>
        const API_URL = 'https://freakymustard.onrender.com';

        const video = document.getElementById('player');
        const track = document.getElementById('subTrack');
        const downloadBtn = document.getElementById('downloadLink');
        const fileInput = document.getElementById('fileInput');
        const toast = document.getElementById('toast');

        const urlParams = new URLSearchParams(window.location.search);
        const activeFileId = urlParams.get('id');
        let streamUrl = "";

        // Default Load
        if (activeFileId) {
            // Update Base URLs to use deployment
            const streamEndpoint = `${API_URL}/api/movies/stream/${activeFileId}`;

            streamUrl = streamEndpoint;
            video.src = streamEndpoint;
            downloadBtn.href = streamEndpoint; // Download link
            track.src = `${API_URL}/api/subtitles/${activeFileId}?t=${Date.now()}`;

            // Load Metadata
            const storedMeta = JSON.parse(localStorage.getItem('currentVideoMeta'));
            if (storedMeta) {
                document.getElementById('metaContainer').style.display = 'block';
                document.getElementById('metaTitle').innerText = storedMeta.title;
                document.getElementById('metaDesc').innerText = storedMeta.description;
                document.title = "Watching: " + storedMeta.title;
            }

            // --- CONTINUE WATCHING (Resume Feature) ---
            const savedTime = localStorage.getItem(`resume_${activeFileId}`);
            if (savedTime && parseFloat(savedTime) > 30) {
                // Auto-resume if past 30s
                video.currentTime = parseFloat(savedTime);
                showToast(`Resume from ${formatResumeTime(savedTime)}`);
            }

            // Save Progress (Throttled to every 5s)
            let lastSave = 0;
            video.addEventListener('timeupdate', () => {
                const now = Date.now();
                if (now - lastSave > 5000) {
                    localStorage.setItem(`resume_${activeFileId}`, video.currentTime);
                    lastSave = now;
                }
            });

        } else {
            alert('No video ID provided!');
            window.location.href = 'movies.html';
        }

        // Toggle Stream Mode (Placeholder as mostly same endpoint now)
        function toggleStreamMode() {
            const currentTime = video.currentTime;
            const isPaused = video.paused;

            // Just reloading for now or we could add a query param to bust cache or something
            video.src = video.src.includes('?') ? video.src.split('?')[0] : video.src + '?turbo=true';

            showToast("üöÄ Turbo Mode Refreshed");

            video.currentTime = currentTime;
            if (!isPaused) video.play();
        }

        // SMART OPEN FUNCTION
        function openExternalPlayer() {
            const isAndroid = /Android/i.test(navigator.userAgent);

            if (isAndroid) {
                const intentUrl = `intent:${streamUrl}#Intent;action=android.intent.action.VIEW;type=video/*;end`;
                window.location.href = intentUrl;
            } else {
                navigator.clipboard.writeText(streamUrl).then(() => {
                    showToast("üìã Link Copied! Paste into your Player.");
                }).catch(() => {
                    showToast("‚ùå Could not copy link.");
                });
            }
        }

        video.onerror = function () {
            showToast("‚ö†Ô∏è Error. Try Turbo Mode or External!");
        };

        function showToast(msg) {
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        fileInput.addEventListener('change', async () => {
            if (fileInput.files.length === 0) return;
            const formData = new FormData();
            formData.append('subtitle', fileInput.files[0]);

            const btn = document.querySelector('.btn-sub');
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚è≥ ...";

            try {
                const res = await fetch(`${API_URL}/api/subtitles/upload/${activeFileId}`, { method: 'POST', body: formData });
                if (res.ok) {
                    showToast("‚úÖ Subtitles Added!");
                    // Cache bust
                    track.src = `${API_URL}/api/subtitles/${activeFileId}?t=${Date.now()}`;
                } else { showToast("‚ùå Failed"); }
            } catch (err) { showToast("‚ùå Error"); }
            finally { btn.innerHTML = originalText; }
        });

        // Helper to load subtitles
        function loadSubtitle(vttUrl) {
            track.src = vttUrl;
            track.track.mode = 'showing'; // Ensure track is visible
            video.textTracks[0].mode = 'showing'; // Ensure track is visible
        }

        async function autoSyncSubs() {
            const storedMeta = JSON.parse(localStorage.getItem('currentVideoMeta'));
            const query = storedMeta ? storedMeta.title : activeFileId;

            showToast("üîç Searching for subtitles...");

            try {
                const res = await fetch(`${API_URL}/api/subtitles/search?query=${encodeURIComponent(query)}&fileId=${activeFileId}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.success && data.vttUrl) {
                        loadSubtitle(data.vttUrl);
                        showToast("‚úÖ Subtitles Synced!");
                    } else {
                        showToast("‚ùå No subtitles found.");
                    }
                } else {
                    showToast("‚ùå Search failed.");
                }
            } catch (e) {
                console.error(e);
                showToast("‚ùå Error searching subs.");
            }
        }

        function formatResumeTime(seconds) {
            const date = new Date(seconds * 1000);
            const hh = date.getUTCHours();
            const mm = date.getUTCMinutes();
            const ss = date.getUTCSeconds().toString().padStart(2, '0');
            if (hh) return `${hh}:${mm.toString().padStart(2, '0')}:${ss}`;
            return `${mm}:${ss}`;
        }
    </script>
</body>

</html>